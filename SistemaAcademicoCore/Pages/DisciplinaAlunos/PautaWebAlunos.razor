@page "/webagenda/students"
@using SistemaAcademicoApplication.Alunos.Queries
@using SistemaAcademicoApplication.DisciplinaAlunos.Queries
@using SistemaAcademicoApplication.Semestres.Queries
@inject IMediator _mediator
@inject ICurrentUserService _currentUserService
@inject IToastService _toastService
@inject NavigationManager _navigationManager

@attribute [Authorize(Policy = Policies.IsAluno)]

<PageTitle>Pauta Web - Aluno</PageTitle>

@if (DisciplinasAlunoList == null)
{
    <br />
    <br />
    <br />
    <center>
        <img src="https://media.giphy.com/media/jAYUbVXgESSti/giphy.gif" class="align-content-center" />
    </center>
}
else
{
    <div class="card">
        <div class="card-header">
            <div class="titulo-card">
                Pauta Web - Aluno
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 col-lg-6 form-space">
                    <div class="form-floating mb-3">
                        <select id="selectSemestre" class="form-select" @onchange="AlteraSemestre">
                            @foreach(var item in Semestres)
                            {
                                if(item.Vigente)
                                {
                                    <option selected value="@item.Ano/@item.Semestre">@item.Ano/@item.Semestre</option>
                                }
                                else
                                {
                                    <option value="@item.Ano.ToString()/@item.Semestre.ToString()">@item.Ano/@item.Semestre</option>
                                }
                            }
                        </select>
                        <label for="selectSemestre">Semestre</label>
                    </div>
                </div>
            </div>
            <DataTable Searchable="true">
                <thead class="thead-light">
                    <tr>
                        <th>Disciplina</th>
                        <th>Total aulas válidas</th>
                        <th>Qtd. Falta</th>
                        <th>Qtd. Presença</th>
                        <th>Avaliação 1</th>
                        <th>Avaliação 2</th>
                        <th>Prova final</th>
                        <th>Nota final</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach(var item in DisciplinasAlunoList.Where(x => x.Excluido == false))
                    {
                        <tr>
                            <td>@item.Disciplina.Nome</td>
                            <td>@item.TotalAulasValidas</td>
                            <td>@item.QuantidadeFalta</td>
                            <td>@item.QuantidadePresenca</td>
                            <td>@item.NotaAvaliacao1</td>
                            <td>@item.NotaAvaliacao2</td>
                            <td>@item.ProvaFinal</td>
                            <td>@item.NotaFinal</td>
                        </tr>
                    }
                </tbody>
            </DataTable>
        </div>
    </div>
}



@code {
    Aluno AlunoLogado;
    List<DisciplinaAluno> DisciplinasAlunoList;
    List<SemestreVigente> Semestres;

    protected override async Task OnInitializedAsync()
    {
        var usuarioLogado = await _currentUserService.GetUserNameAsync();
        var alunoLogado = await _mediator.Send(new ObterAlunoEmailQuery { Email = usuarioLogado });
        AlunoLogado = alunoLogado.Result;

        Semestres = await GetSemestresAsync();
        DisciplinasAlunoList = await GetDisciplinasAlunoAsync(AlunoLogado.AlunoId);
    }

    private void AlteraSemestre(ChangeEventArgs ev)
    {
        var source = ev.Value.ToString();
        var split = source.Split("/");

        DisciplinasAlunoList = DisciplinasAlunoList.Where(x => x.Ano == Convert.ToInt32(split[0]) && x.Semestre == Convert.ToInt32(split[1])).ToList();
        StateHasChanged();
    }

    private async Task<List<DisciplinaAluno>> GetDisciplinasAlunoAsync(int alunoId)
    {
        return await Task.FromResult((await _mediator.Send(new ObterPautaWebAlunoQuery { AlunoId = alunoId })).Result);
    }

    private async Task<List<SemestreVigente>> GetSemestresAsync()
    {
        return await Task.FromResult((await _mediator.Send(new ObterSemestresQuery())).Result);
    }
}
