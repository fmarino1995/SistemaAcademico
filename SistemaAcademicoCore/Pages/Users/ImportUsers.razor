@page "/users/import"
@using Microsoft.AspNetCore.Mvc
@using System.Text
@using System.Text.Encodings.Web
@using SistemaAcademicoApplication.Usuarios.Commands
@inject IMediator _mediator
@inject IEmailService _emailService
@inject IWebHostEnvironment _env
@inject UserManager<ApplicationUser> _userManager


<div class="card">
    <div class="card-header">
        <div class="titulo-card">
            Importação de usuários
        </div>
    </div>
    <div class="card-body">
        <form @onsubmit="OnSubmit">
            <InputFile OnChange="OnInputFileChange" multiple />
            <br /><br />
            <button type="submit" class="btn btn-outline-primary">Enviar</button>
        </form>
    </div>
    <div class="card-footer">
    </div>
</div>



@code {
    string returnUrl = null;
    string EmailConfirmationUrl = string.Empty;
    string Message = "Nenhum arquivo selecionado";
    IBrowserFile selectedFiles;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFiles = e.File;
    }

    private async void OnSubmit()
    {

        string filePath = $"C:\\arquivosImportacaoUsuario\\{selectedFiles.Name}_{DateTime.Now.ToString("dd-MM-yyyy").Replace("-","")}_{DateTime.Now.Ticks}";

        var importacaoResponse = await _mediator.Send(new ImportarLoteUsuariosCommand { File = selectedFiles, FilePath = filePath });


        foreach (var user in importacaoResponse.Result.Users)
        {

            EMailRequest emailModel = new EMailRequest
                {
                    ToEmail = user.Email,
                    Subject = "Confirmação de conta - Sistema Acadêmico",
                    Body = "<h2><strong>Seja bem vindo ao Sistema Academico!</strong></h2> <br/>" +
                                        $"<p>Nome de Usuário : {user.Email}</p><br/>" +
                                        $"<p>Senha temporária : {user.Senha}</p><br/>" + 
                                        "<strong>Altere sua senha no primeiro acesso.</strong>",
                    UserName = user.NomeCompleto,
                    Attachments = null
                };

            await _emailService.SendEmailAsync(emailModel);
        }
    }
}
